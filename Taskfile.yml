version: '3'

vars:
  DC_DIR: "deployment/docker-compose"
  INFRA_DC_FILE: "{{.DC_DIR}}/infra.yml"
  APPS_DC_FILE: "{{.DC_DIR}}/apps.yml"

  ENV: '{{default "dev" .ENV}}'
  ENV_FILE: '{{printf "%s/.env.%s" .DC_DIR .ENV}}'

  DC_INFRA_ARGS: '--env-file {{.ENV_FILE}} -f {{.INFRA_DC_FILE}}'
  DC_ALL_ARGS:   '--env-file {{.ENV_FILE}} -f {{.INFRA_DC_FILE}} -f {{.APPS_DC_FILE}}'

tasks:

  default:
    cmds:
      - task: ps

  # -------------------------
  # Infra
  # -------------------------

  setup_dirs:
    cmds:
      - sudo mkdir -p deployment/docker-compose/loki
      - sudo chown -R 10001:10001 deployment/docker-compose/loki || true
      - sudo chmod -R u+rwX deployment/docker-compose/loki || true

  start_infra:
    deps: [setup_dirs]
    cmds:
      - docker compose {{.DC_INFRA_ARGS}} up -d

  stop_infra:
    cmds:
      - docker compose {{.DC_INFRA_ARGS}} stop
      - docker compose {{.DC_INFRA_ARGS}} rm -f

  # -------------------------
  # Apps
  # -------------------------

  pull:
    desc: "Pull latest images"
    cmds:
      - docker compose {{.DC_ALL_ARGS}} pull

  start:
    desc: "Start all services"
    deps: [setup_dirs]
    cmds:
      - echo "ENV={{.ENV}}"
      - docker compose {{.DC_ALL_ARGS}} pull
      - docker compose {{.DC_ALL_ARGS}} up -d --force-recreate

  stop:
    cmds:
      - docker compose {{.DC_ALL_ARGS}} stop
      - docker compose {{.DC_ALL_ARGS}} rm -f

  restart:
    cmds:
      - task: stop
      - task: start

  # -------------------------
  # Service Controls
  # -------------------------

  restart_service:
    desc: "Restart one service. SERVICE=name"
    vars:
      SERVICE: '{{.SERVICE}}'
    cmds:
      - |
        [ -n "{{.SERVICE}}" ] || { echo "Provide SERVICE=name"; exit 1; }
        docker compose {{.DC_ALL_ARGS}} pull {{.SERVICE}}
        docker compose {{.DC_ALL_ARGS}} up -d --force-recreate {{.SERVICE}}

  logs:
    vars:
      SERVICE: '{{.SERVICE}}'
    cmds:
      - |
        [ -n "{{.SERVICE}}" ] || { echo "Provide SERVICE=name"; exit 1; }
        docker compose {{.DC_ALL_ARGS}} logs -f {{.SERVICE}}

  ps:
    cmds:
      - docker compose {{.DC_ALL_ARGS}} ps

  # -------------------------
  # Cleanup
  # -------------------------

  prune:
    cmds:
      - docker image prune -f
      - docker builder prune -f
      - docker volume prune -f
